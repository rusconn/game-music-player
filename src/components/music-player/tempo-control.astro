---
import type { HTMLAttributes } from "astro/types";

import ControlButton from "./control-primitives/button.astro";
import ControlIcon from "./control-primitives/icon.astro";
import ControlBar from "./control-primitives/bar.astro";

type Props = HTMLAttributes<"div">;

const { props } = Astro;
---

<tempo-control {...props}>
  <ControlButton class="tempo-button" disabled>
    <ControlIcon class="tempo-icon" iconId="mdi--metronome" />
  </ControlButton>
  <ControlBar class="tempo-bar" min="0.5" max="1.5" value="1" step="0.01" disabled />
  <span class="tempo-text">1.00</span>
</tempo-control>

<script>
  import type { Music } from "../../models/music";
  import { queryMusicPlayer } from "../../utils/query";
  import type { MusicPlayerElement } from "../music-player.astro.0.mts";
  import type { ControlBarElement } from "./control-primitives/bar.astro.0.mts";
  import type { ControlButtonElement } from "./control-primitives/button.astro.0.mts";

  export class TempoControlElement extends HTMLElement {
    #musicPlayer!: MusicPlayerElement;

    #tempoButton!: ControlButtonElement;
    #tempoBar!: ControlBarElement;
    #tempoText!: HTMLSpanElement;

    connectedCallback() {
      this.#musicPlayer = queryMusicPlayer();

      this.#tempoButton = this.querySelector(".tempo-button")!;
      this.#tempoBar = this.querySelector(".tempo-bar")!;
      this.#tempoText = this.querySelector(".tempo-text")!;

      this.#tempoButton.addEventListener("click", async () => {
        await this.#musicPlayer.send({ type: "SET_TEMPO", tempo: 1.0 });
      });

      this.#tempoBar.addEventListener("input", async (e) => {
        const input = e.target as HTMLInputElement;
        const value = Number(input.value);
        await this.#musicPlayer.send({ type: "SET_TEMPO", tempo: value });
      });
    }

    get tempo() {
      return Number(this.#tempoBar.value);
    }

    set tempo(tempo: number) {
      const tempoValue = tempo.toFixed(2);
      this.#tempoBar.value = tempoValue;
      this.#tempoText.textContent = tempoValue;
    }

    get min() {
      return Number(this.#tempoBar.min);
    }

    get max() {
      return Number(this.#tempoBar.max);
    }

    load({ settings }: Music) {
      this.tempo = settings.tempo;
      this.#tempoButton.enable();
      this.#tempoBar.enable();
    }
  }

  if (!customElements.get("tempo-control")) {
    customElements.define("tempo-control", TempoControlElement);
  }
</script>

<style>
  tempo-control {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
</style>
