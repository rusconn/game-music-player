---
import type { HTMLAttributes } from "astro/types";

import ControlButton from "./control-primitives/button.astro";
import ControlIcon from "./control-primitives/icon.astro";
import ControlBar from "./control-primitives/bar.astro";

type Props = HTMLAttributes<"div">;

const { props } = Astro;
---

<volume-control {...props}>
  <ControlButton class="mute-button" disabled>
    <ControlIcon class="volume-icon" iconId="clarity--volume-up-solid" />
    <ControlIcon class="muted-icon" iconId="clarity--volume-mute-solid" hidden />
  </ControlButton>
  <ControlBar class="volume-bar" min="0" max="100" step="5" value="100" disabled />
  <span class="volume-text">100</span>
</volume-control>

<script>
  import type { Music } from "../../models/music";
  import { queryMusicPlayer } from "../../utils/query";
  import type { MusicPlayerElement } from "../music-player.astro.0.mts";
  import type { ControlBarElement } from "./control-primitives/bar.astro.0.mts";
  import type { ControlButtonElement } from "./control-primitives/button.astro.0.mts";
  import type { ControlIconElement } from "./control-primitives/icon.astro.0.mts";

  export class VolumeControlElement extends HTMLElement {
    #musicPlayer!: MusicPlayerElement;

    #muteButton!: ControlButtonElement;
    #volumeIcon!: ControlIconElement;
    #mutedIcon!: ControlIconElement;
    #volumeBar!: ControlBarElement;
    #volumeText!: HTMLSpanElement;

    connectedCallback() {
      this.#musicPlayer = queryMusicPlayer();

      this.#muteButton = this.querySelector(".mute-button")!;
      this.#volumeIcon = this.#muteButton.querySelector(".volume-icon")!;
      this.#mutedIcon = this.#muteButton.querySelector(".muted-icon")!;
      this.#volumeBar = this.querySelector(".volume-bar")!;
      this.#volumeText = this.querySelector(".volume-text")!;

      this.#muteButton.addEventListener("click", async () => {
        await this.#musicPlayer.send({ type: "TOGGLE_MUTE" });
      });

      this.#volumeBar.addEventListener("input", async (e) => {
        const input = e.currentTarget as ControlBarElement;
        const value = Number(input.value);
        await this.#musicPlayer.send({ type: "SET_VOLUME", volume: value / 100 });
      });
    }

    get volume() {
      return Number(this.#volumeBar.value) / 100;
    }

    set volume(volume: number) {
      const volumeValue = Math.round(volume * 100).toString();
      this.#volumeBar.value = volumeValue;
      this.#volumeText.textContent = volumeValue;
    }

    get min() {
      return Number(this.#volumeBar.min) / 100;
    }

    get max() {
      return Number(this.#volumeBar.max) / 100;
    }

    load({ settings }: Music) {
      this.volume = settings.volume;
      this.#muteButton.enable();
      this.#volumeBar.enable();
    }

    toggleIcon() {
      this.#volumeIcon.toggle();
      this.#mutedIcon.toggle();
    }
  }

  if (!customElements.get("volume-control")) {
    customElements.define("volume-control", VolumeControlElement);
  }
</script>

<style>
  volume-control {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
</style>
