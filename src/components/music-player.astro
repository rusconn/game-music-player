---
import TitleDisplay from "./music-player/title-display.astro";
import PlayControl from "./music-player/play-control.astro";
import VolumeControl from "./music-player/volume-control.astro";
import TempoControl from "./music-player/tempo-control.astro";
---

<music-player>
  <audio src="5-seconds-of-silence.mp3" loop></audio>
  <TitleDisplay class="title-display" />
  <PlayControl class="play-control" />
  <div class="volume-and-tempo">
    <VolumeControl class="volume-control" />
    <TempoControl class="tempo-control" />
  </div>
</music-player>

<script>
  import type { Music } from "../models/music";
  import { MusicPlayer } from "../models/music-player";
  import { queryMusicTabulizer } from "../utils/query";
  import type { TitleDisplayElement } from "./music-player/title-display.astro.0.mts";
  import type { PlayControlElement } from "./music-player/play-control.astro.0.mts";
  import type { VolumeControlElement } from "./music-player/volume-control.astro.0.mts";
  import type { TempoControlElement } from "./music-player/tempo-control.astro.0.mts";
  import type { MusicTabulizerElement } from "./music-tabulizer.astro.0.mts";

  type State = "unloaded" | "loading" | "playing" | "paused";

  export class MusicPlayerElement extends HTMLElement {
    #musicTabulizer!: MusicTabulizerElement;

    #audioForMediaSession!: HTMLAudioElement;
    #titleDisplay!: TitleDisplayElement;
    #playControl!: PlayControlElement;
    #volumeControl!: VolumeControlElement;
    #tempoControl!: TempoControlElement;

    #musicPlayer = new MusicPlayer();
    #loadedMusic: Music | undefined;
    #updateDisplayRequestId = 0;
    #state: State = "unloaded";

    connectedCallback() {
      this.#musicTabulizer = queryMusicTabulizer();

      this.#audioForMediaSession = this.querySelector("audio")!;
      this.#titleDisplay = this.querySelector(".title-display")!;
      this.#playControl = this.querySelector(".play-control")!;
      this.#volumeControl = this.querySelector(".volume-control")!;
      this.#tempoControl = this.querySelector(".tempo-control")!;

      this.#setMediaSessionHandlers();
    }

    #setMediaSessionHandlers() {
      navigator.mediaSession.setActionHandler("play", this.togglePlay.bind(this));
      navigator.mediaSession.setActionHandler("pause", this.togglePlay.bind(this));
    }

    set volume(volume: number) {
      this.#musicPlayer.volume = volume;
      this.#loadedMusic?.updateSettings({ volume });
    }

    set tempo(tempo: number) {
      this.#musicPlayer.tempo = tempo;
      this.#loadedMusic?.updateSettings({ tempo });
    }

    async play(music: Music) {
      this.#stopUpdateDisplay();

      this.#state = "loading";
      this.#titleDisplay.load(music);
      this.#playControl.load(music);
      this.#volumeControl.load(music);
      this.#tempoControl.load(music);
      this.#loadedMusic = music;
      this.#loadMediaSession(music);

      await this.#musicPlayer.play(music);
      this.#startUpdateDisplay();
      this.#mediaSessionToPlaying();
      this.#playControl.enable();
      this.#volumeControl.enable();
      this.#tempoControl.enable();
      this.#state = "playing";
    }

    #loadMediaSession({ file, metadata }: Music) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: metadata.common.title ?? file.name,
        artist: metadata.common.artist,
        album: metadata.common.album,
      });

      navigator.mediaSession.setPositionState({
        position: 0,
        duration: 0,
      });

      this.#mediaSessionToPaused();
    }

    #mediaSessionToPlaying() {
      this.#audioForMediaSession.play();
      navigator.mediaSession.playbackState = "playing";
    }

    #mediaSessionToPaused() {
      this.#audioForMediaSession.pause();
      navigator.mediaSession.playbackState = "paused";
    }

    #stopUpdateDisplay() {
      cancelAnimationFrame(this.#updateDisplayRequestId);
    }

    #startUpdateDisplay() {
      this.#updateDisplayRequestId = requestAnimationFrame(this.#updateDisplay.bind(this));
    }

    #updateDisplay() {
      this.#playControl.update(this.#musicPlayer.currentTime ?? 0);
      this.#updateDisplayRequestId = requestAnimationFrame(this.#updateDisplay.bind(this));
    }

    async togglePlay() {
      await this.#musicPlayer.togglePlay();
      this.#musicTabulizer.togglePlay();
      this.#playControl.toggleIcon();

      switch (this.#state) {
        case "playing":
          this.#state = "paused";
          this.#stopUpdateDisplay();
          break;
        case "paused":
          this.#state = "playing";
          this.#startUpdateDisplay();
          break;
      }

      this.#toggleMediaSession();
    }

    #toggleMediaSession() {
      this.#audioForMediaSession.paused
        ? this.#audioForMediaSession.play()
        : this.#audioForMediaSession.pause();

      navigator.mediaSession.playbackState =
        navigator.mediaSession.playbackState === "paused" //
          ? "playing"
          : "paused";
    }

    async seek(toSec: number) {
      await this.#musicPlayer.seek(toSec);
    }

    toggleMute() {
      this.#musicPlayer.toggleMute();
    }
  }

  if (!customElements.get("music-player")) {
    customElements.define("music-player", MusicPlayerElement);
  }
</script>

<style>
  music-player {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .volume-and-tempo {
    display: flex;
    justify-content: space-between;
    gap: 1.125rem;
  }
</style>
