# 色々な開発メモ

技術的な決定や開発日記のような雑多なドキュメントです。

## 開発の背景

僕はよくPCゲームをプレイするのだが、ゲームで使われている音楽をゲーム外でも聴けるといいなと思っていた。いわゆる作業用BGMってやつ。でも手元のプレイヤーではゲーム中のような再生が出来なかった。いい感じのプレイヤーがないか探していたら、[LoopMusicPlayer-Web](https://github.com/Mr-Ojii/LoopMusicPlayer-Web)を見つけた。しばらくこれにお世話になっていたのだが、修行がてら自分でも作ってみたくなった。

## 何を作るかの決定

自分には潤沢な開発リソースがあるとは思わないし、Webフロントエンドが特別得意なわけでもない。むしろCSSなんかはいまだに苦手意識があるくらいだ。なので大きくて立派なものを目指すのではなく、小規模でニッチなものを作ろうと思った。高機能路線は目指さない。オーディオ全般ではなく、ゲーム音楽というドメインに絞ったのはこの為だ。アートワークは無いだろうから表示する必要がない。ファイル数も少ないだろうからグルーピング機能やタグ機能も必要ない。長時間の音声ファイルに対応する必要もない。よし、これで行こう。

## 欲しかったもの

- 複数ファイルの一括アップロード
  - 雑に音楽ファイルを集めて一発でアップロード完了
- oggループ
  - 必須
- 再生速度・音程の変更
  - たまにゲーム側で再生速度を変更していることがある
- 各種設定の自動保存
  - いちいち設定し直さなくていい
- イヤホンの再生・一時停止ボタンからのコントロール
  - プレイヤーの画面を探し出して操作しなくていい

## 開発環境の決定

最初はindex.htmlにベタ書きでいいと思っていた。しかし開発を進めていくと、ライブラリのバンドルやTypeScript対応が欲しくなった。ゼロコンフィグかつ馴染みのある環境はNext.jsかAstroだったのだが、Next.jsはオーバーキルであると思いAstroにした。

## UIライブラリの決定

Astroはインテグレーションを通じて色々なUIライブラリを利用できる。React,Vue,Svelte,Solid,...。Reactなら自分の主戦場なのだが、小さなものを作るのにわざわざ持ち出すこともないと思って使わないことにした。次にSvelteを検討したが、残念ながら私がSvelteに不慣れなので見送ることにした。ドメインの複雑さとライブラリの学習コストが同時にやってくると辛いんだ。

結局、全部Astro標準テンプレートでいくことにした。久しぶりに命令的UIを書こうじゃないか。意外といいかもよ？

## 依存を減らす

せっかくだから、Reactに限らず他のライブラリもできるだけ使わないでいこう。バンドルが大きくなりにくいし、アップデートに悩まされることもないし、依存の解決でハマることもなくなりそうだし。自分で書けるところは自分で書いていこう。

## コンポーネント分割

いざ書き出してみると意外と大きなコードになったので、複数のastroファイルを用意してコンポーネント単位の開発をすることにした。ここで問題になったのがコンポーネント間のやり取り方法。どうやって通信をするんだ？調べてみると、カスタムイベントやカスタム要素により実現可能であることがわかった。どうやらカスタム要素ではメソッド呼び出しという形でコンポーネント間の通信ができるらしい。これにしよう。図らずもWeb Componentsデビュー。

## 惜しいaudio要素、憎いWeb Audio API

audio要素は素晴らしい。シークバーUI、音量調整UI、ストリーミング的な？デコード、再生速度の変更、曲全体のループ、OSのメディアコントロール機能を通じた制御、などなど、多数の機能を提供してくれる。ただし、oggのループタグに応じたループだけは実現が難しかった。タイミングを見計らって再生位置をループ開始位置へ戻す、という方法も試したのだが、どうしても違和感のあるループになってしまった。残念。諦めてWeb Audio APIを使うことにした。

で、このWeb Audio API、使いにくい。メモリをやたらと消費するし、デコードが遅いし、曲の切り替えでポップノイズが出るし、AudioBufferSourceNodeが使い捨てなので毎回作り直さないといけないし、AudioContextの初期化で叱られるし、そもそも意味が分かりにくいし…。でもスムーズなoggループは捨てられない。頑張って対応することにした。audio要素ならたった数行なのにね。

一通り対応が終わって確認したところ、Web Audio APIによるオーディオ再生ではOSのメディアコントロール機能を通じた制御ができなかった。ファック。audio要素へ繋いで音を鳴らすことはできる。がっ…駄目！解決策として、Web Audio APIによるオーディオ再生と連動する形でaudio要素に無音ファイルを再生してもらうことになった。マジ！？

## ひとまず作り終えた

なんとか最初のリリースに漕ぎつけた。当初は3日やそこらで作れるだろうと思っていたが、実際には2週間かかった。作っていくうちに色々こだわり始めたのはあるが、見通しが甘かった感も否めない。

ここで少し困難を振り返ってみよう。

### table要素

#### 行ボタン実現

曲一覧テーブルの行をクリックすると当該曲が再生されるというUXを実現したかった。これが難しい。tr要素全体をボタンにしたい、ということになるが、tr要素の小要素はtd要素である必要がある。td要素の小要素にbutton要素を入れても、通常は行全体のボタンにはならない。当然のように存在するUXだと思うが、意外とワークアラウンドが必要になる。

#### スタイリング問題

- 行と行の間に微妙な隙間ができる
- 行と行が微妙に重なる箇所がある
- 行とボタンのブロック方向の位置が微妙にズレる

今後新しい問題が出てきたらul要素へ逃げるかもしれない。

### 範囲ループの曲をloopEndより後へシークした際の挙動

強制的に範囲ループ開始位置へ戻すのか、シークに従うが以降ループはしないのか、シークに従い曲全体ループをし、再び範囲ループへ戻るのか。欲張れば欲張るほどコードが複雑化し、バグに悩まされる。

### シークバー

曲の再生中にリアルタイムでバーが動いて欲しいが、自分で作るのはやや面倒だった。スクリプトから1フレーム毎に値を更新する方法をとったが、ユーザーのシークを妨げないよう工夫する必要があった。audio要素使いたいよね。

### テンポ変更時の再生時間調整

テンポを変更したら、それに伴い再生時間の変動スピードも変更しなければならない。よく考えたらそれほど複雑ではなかったが、実装前はビビっていた。

### アニメーションの状態管理

曲を再生すると波形状のアニメーションが開始し、曲を一時停止するとアニメーションも一時停止するようにコーディングした。ここで問題になったのが、曲を切り替えた際のアニメーション初期化。そのままにしてしまうと、まるでレジュームできるかのような印象を与えてしまう。調査して状態の初期化を実現できたが、ちょっと歪な方法になってしまったようにも思う。停止中の曲に表示するインジケーターを波形から変更するのもいいかもしれない。

### Web Audio APIの使い方がよくわからない問題

やたらと難しく感じる。僕の飲み込みが悪いのだろうか。レシピ集が欲しい。

### メディア通知のデバッグ問題

メディアセッションAPIを使ってメディア通知をコントロールしているが、モバイル上でどのように表示されるのかがわからなかった。デプロイ&実機での確認を繰り返していて、効率が悪かった。

---

こんなところだろうか。ともかく、形になってよかった。今後少しずつドッグフードしていこう。
